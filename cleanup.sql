-- Script for partially anonymizing and cleaning up the dump.
-- WARNING: The script is not guaranteed to cover any kind of metastore
-- (not even close). It is mostly suitable for cases encountered so far.

-- Statements to remove potentially sensitive URIs and usernames.
UPDATE "CTLGS" SET "LOCATION_URI" = REGEXP_REPLACE("LOCATION_URI",'(s3a|hdfs)://[^/]+','hdfs://localhost:40889');
UPDATE "DBS" SET "DB_LOCATION_URI" = REGEXP_REPLACE("DB_LOCATION_URI",'(s3a|hdfs)://[^/]+','hdfs://localhost:40889');
UPDATE "DBS" SET "OWNER_NAME" = 'hive' WHERE "OWNER_NAME" IS NOT NULL AND "OWNER_NAME" <> 'public';
UPDATE "SDS" SET "LOCATION" = REGEXP_REPLACE("LOCATION",'(s3a|hdfs)://[^/]+','hdfs://localhost:40889') WHERE "LOCATION" IS NOT NULL;
UPDATE "TBLS" SET "OWNER" = 'hive' WHERE "OWNER" IS NOT NULL AND "OWNER" <> 'public';
-- Statements to cleanup potentiall incomplete transactions.
TRUNCATE TABLE "HIVE_LOCKS" CASCADE ;
TRUNCATE TABLE "NOTIFICATION_LOG";
TRUNCATE TABLE "TXNS" CASCADE;
TRUNCATE TABLE "TXN_TO_WRITE_ID";

-- Statements to replace Hive default database with tpcds
DELETE FROM "TABLE_PARAMS" WHERE "TBL_ID" IN (SELECT "TBLS"."TBL_ID" FROM "TBLS" WHERE EXISTS (SELECT 1 FROM "DBS" WHERE "DBS"."DB_ID"="TBLS"."DB_ID" AND "NAME" = 'default'));
DELETE FROM "TAB_COL_STATS" WHERE "TBL_ID" IN (SELECT "TBLS"."TBL_ID" FROM "TBLS" WHERE EXISTS (SELECT 1 FROM "DBS" WHERE "DBS"."DB_ID"="TBLS"."DB_ID" AND "NAME" = 'default'));
DELETE FROM "MV_TABLES_USED" WHERE "TBL_ID" IN (SELECT "TBLS"."TBL_ID" FROM "TBLS" WHERE EXISTS (SELECT 1 FROM "DBS" WHERE "DBS"."DB_ID"="TBLS"."DB_ID" AND "NAME" = 'default'));
DELETE FROM "TBL_PRIVS" WHERE "TBL_ID" IN (SELECT "TBLS"."TBL_ID" FROM "TBLS" WHERE EXISTS (SELECT 1 FROM "DBS" WHERE "DBS"."DB_ID"="TBLS"."DB_ID" AND "NAME" = 'default'));
DELETE FROM "PARTITION_KEYS" WHERE "TBL_ID" IN (SELECT "TBLS"."TBL_ID" FROM "TBLS" WHERE EXISTS (SELECT 1 FROM "DBS" WHERE "DBS"."DB_ID"="TBLS"."DB_ID" AND "NAME" = 'default'));
DELETE FROM "PARTITION_KEY_VALS" WHERE "PART_ID" IN (SELECT "PART_ID" FROM "PARTITIONS" WHERE "TBL_ID" IN (SELECT "TBLS"."TBL_ID" FROM "TBLS" WHERE EXISTS (SELECT 1 FROM "DBS" WHERE "DBS"."DB_ID"="TBLS"."DB_ID" AND "NAME" = 'default')));
DELETE FROM "PARTITION_PARAMS" WHERE "PART_ID" IN (SELECT "PART_ID" FROM "PARTITIONS" WHERE "TBL_ID" IN (SELECT "TBLS"."TBL_ID" FROM "TBLS" WHERE EXISTS (SELECT 1 FROM "DBS" WHERE "DBS"."DB_ID"="TBLS"."DB_ID" AND "NAME" = 'default')));
DELETE FROM "PART_COL_STATS" WHERE "PART_ID" IN (SELECT "PART_ID" FROM "PARTITIONS" WHERE "TBL_ID" IN (SELECT "TBLS"."TBL_ID" FROM "TBLS" WHERE EXISTS (SELECT 1 FROM "DBS" WHERE "DBS"."DB_ID"="TBLS"."DB_ID" AND "NAME" = 'default')));
DELETE FROM "PARTITIONS" WHERE "TBL_ID" IN (SELECT "TBLS"."TBL_ID" FROM "TBLS" WHERE EXISTS (SELECT 1 FROM "DBS" WHERE "DBS"."DB_ID"="TBLS"."DB_ID" AND "NAME" = 'default'));
DELETE FROM "KEY_CONSTRAINTS" WHERE "PARENT_TBL_ID" IN (SELECT "TBLS"."TBL_ID" FROM "TBLS" WHERE EXISTS (SELECT 1 FROM "DBS" WHERE "DBS"."DB_ID"="TBLS"."DB_ID" AND "NAME" = 'default'));
DELETE FROM "KEY_CONSTRAINTS" WHERE "CHILD_TBL_ID" IN (SELECT "TBLS"."TBL_ID" FROM "TBLS" WHERE EXISTS (SELECT 1 FROM "DBS" WHERE "DBS"."DB_ID"="TBLS"."DB_ID" AND "NAME" = 'default'));

DELETE FROM "TBLS" WHERE "DB_ID" IN (SELECT "DB_ID" FROM "DBS" WHERE "NAME" = 'default');

UPDATE "TBLS" SET "DB_ID" = (SELECT "DB_ID" FROM "DBS" WHERE "NAME" = 'default') WHERE EXISTS (SELECT 1 FROM "DBS" WHERE "DBS"."DB_ID"="TBLS"."DB_ID" AND "DBS"."NAME" LIKE 'tpcds%');

TRUNCATE "DATABASE_PARAMS";
DELETE FROM "DBS" WHERE "NAME" LIKE 'tpcds%';

UPDATE "TAB_COL_STATS" SET "DB_NAME" = 'default' WHERE "DB_NAME" LIKE 'tpcds%';
UPDATE "PART_COL_STATS" SET "DB_NAME" = 'default' WHERE "DB_NAME" LIKE 'tpcds%';
